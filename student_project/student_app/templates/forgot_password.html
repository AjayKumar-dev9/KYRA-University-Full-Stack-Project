{% extends "extent.html" %}
{% block content %}
<title>Forgot Password</title>
<style>
body {
    font-family: Arial, sans-serif;
    background: #f4f6f8;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    margin: 0;
}

.container {
    background: #fff;
    padding: 20px 25px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    width: 320px;
}

h2 {
    text-align: center;
    margin-bottom: 20px;
    color: #333;
}

label {
    display: block;
    margin-top: 12px;
    font-weight: bold;
    color: #555;
}

input {
    width: 100%;
    padding: 10px;
    margin-top: 6px;
    border: 1px solid #ccc;
    border-radius: 5px;
    font-size: 14px;
}

button {
    width: 100%;
    padding: 10px;
    margin-top: 12px;
    background-color: #007bff;
    border: none;
    color: white;
    font-size: 15px;
    border-radius: 5px;
    cursor: pointer;
    transition: background 0.3s;
}

button:hover {
    background-color: #0056b3;
}

.resend-btn {
    background-color: #6c757d;
}

.resend-btn:hover {
    background-color: #5a6268;
}

</style>

<div class="container">
    <h2>Forgot Password</h2>

    <div id="message" style="font-weight:bold; font-size: medium;"></div>

    <form method="POST" action="">
        {% csrf_token %}

        <label for="email">Email:</label>
        <input type="email" id="email" name="email" required>

        <button type="button" id="email_send">Send OTP</button>
        <button type="button" id="resend" class="resend-btn">Resend OTP</button>

        <label for="otp">Enter OTP:</label>
        <input type="text" id="otp" name="otp">

        <button type="button" id="otp_send">Submit</button>
    </form>
</div>
<script>
    function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
    }

    resend_btn = document.querySelector('#resend')
    resend_btn.style.display = 'none';
    document.querySelector('#email_send').addEventListener('click',function(){
        email = document.querySelector('#email').value.trim();
        const for_email = "for_email"

        resend_btn.style.display = '';

        send_otprequest(email,for_email)
    });
    document.querySelector('#resend').addEventListener('click',function(){
        email = document.querySelector('#email').value.trim();
        const for_email = "for_email"

        send_otprequest(email,for_email)
    });
    function send_otprequest(email,for_email){
    fetch('/forgotpassword/',{method:"POST", body:JSON.stringify({email:email,for_email:for_email}),
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        credentials: 'same-origin'
        })
        .then(res=>res.json())
        .then(data=>{
            let messageDiv = document.querySelector('#message');
            if (data.success){
                messageDiv.className = 'success-message';
                messageDiv.textContent = data.message;
            }else{
                messageDiv.className = 'error-message';
                messageDiv.textContent = data.error || 'Something went wrong.';
            }
        })
        .catch(error=>{
            let messageDiv = document.querySelector('#message');
            messageDiv.className = 'error-message';
            messageDiv.textContent = 'Network error. Please try again.';
        });  
    };
    document.querySelector('#otp_send').addEventListener('click',function(){
    const otp = document.querySelector('#otp').value;
    const for_otp = 'for_otp';

    fetch('/forgotpassword/',{method:'POST',body:JSON.stringify({otp:otp,for_otp:for_otp}),
    headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        credentials: 'same-origin'
    }).then(res=>res.json())
    .then(data=>{
      let messageDiv = document.querySelector('#message');
      if(data.success){
        messageDiv.className = 'success-message';
        messageDiv.textContent = data.message;
        setTimeout(() => {
                window.location.href = data.redirect_url;
            }, 1500);
      }else{
        messageDiv.className = 'error-message';
        messageDiv.textContent = data.error || 'Something went wrong.';
     }
    })
    .catch(error => {
        let messageDiv = document.querySelector('#message');
        messageDiv.className = 'error-message';
        messageDiv.textContent = 'Network error. Please try again.';
    });
  });
</script>
{% endblock content %}